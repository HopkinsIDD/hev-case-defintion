---
title: "BD combos"
author: "Aybuke Koyuncu"
date: "2025-05-02"
output: html_document
---

At least ONE symptom. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Loading packages 
library(here)
library(gtsummary)
library(knitr)
library(cowplot)
library(ggridges)
library(bayesplot)
library(icenReg)
library(dplyr)
library(rpart)
library(rpart.plot)
library(SuperLearner)
library(ROCR)
library(ggplot2)
library(readr)
library(janitor)
library(dplyr)
library(readxl)
library(tidyr)
library(ranger)
library(kernlab)
library(xgboost)
library(ResourceSelection)
library(pROC)

# Datasets restricted to 30 days post jaundice onset
dat_bd_symp <- readRDS("~/Desktop/GitRepos/hev_bentiu/scripts/Case_definitions/dat_bd_adjusted.rds")

# Remove the demographics
dat_bd_symp <- dat_bd_symp %>% select(-age, -sex, -days_since_ajs)

```


```{r combo}

# Define symptom variables
symptom_names <- c(
  "fever_ever", "nausea_ever", "vomit_ever", "appetite_ever",
  "abdomen_ever", "diarrhea_ever", "constipate_ever", "melaena_ever", "head_ever", "convulsion_ever", "unconsc_ever", "drowsy_ever", "mental_ever", "exam_liver_palp", "exam_dehydrate",
  "exam_oedema", "exam_dist_abdomen"
)

# Generate all subsets of symptoms (case definitions)
case_definitions <- lapply(1:length(symptom_names), function(k) {
  combn(symptom_names, k, simplify = FALSE)
}) |> unlist(recursive = FALSE)

# Set batching parameters
total_defs <- length(case_definitions)
batch_size <- 500
num_batches <- ceiling(total_defs / batch_size)

# Loop through batches
for (batch in 1:num_batches) {
  start_i <- (batch - 1) * batch_size + 1
  end_i <- min(batch * batch_size, total_defs)

  message("Processing batch ", batch, " (", start_i, " to ", end_i, ")")

  # Create an empty list to store case def columns
  batch_case_defs <- list()

  for (i in start_i:end_i) {
    case_def <- case_definitions[[i]]
    case_def_name <- paste0("case_def", i)

    # Use your original logic: OR = any symptom present
    batch_case_defs[[case_def_name]] <- apply(dat_bd_symp, 1, function(row) {
      any(row[case_def] == 1)
    })
  }

  # Combine the case def columns into a data frame
  batch_df <- as.data.frame(batch_case_defs)
  batch_df <- batch_df %>% mutate(across(starts_with("case_def"), as.integer))

  
  # Save this batch separately
  saveRDS(batch_df, file = paste0("case_def_batch_bd", batch, ".rds"))
}

# Start with the original data
final_df <- dat_bd_symp

# Append each batch of case definitions
for (batch in 1:num_batches) {
  path <- here("scripts", "Case_definitions", "BD batches", paste0("case_def_batch_bd", batch, ".rds"))
  batch_df <- readRDS(path)
  final_df <- cbind(final_df, batch_df)
}


```

Now estimate the sensitivity and specificty of each combination of symptoms (i.e. each case definition)

```{r sens_spec}

dat_bd_symp <- final_df

# Get combination column names
case_def_cols <- (grep("^case_def", names(dat_bd_symp), value = TRUE))

# Initialize an empty list to store results
results_list <- list()

for (case_col in case_def_cols) {
  # Calculate confusion matrix components
  tp <- sum(dat_bd_symp[[case_col]] == 1 & dat_bd_symp$infect_bin == 1)
  fp <- sum(dat_bd_symp[[case_col]] == 1 & dat_bd_symp$infect_bin == 0)
  tn <- sum(dat_bd_symp[[case_col]] == 0 & dat_bd_symp$infect_bin == 0)
  fn <- sum(dat_bd_symp[[case_col]] == 0 & dat_bd_symp$infect_bin == 1)

  sens_ci <- prop.test(tp, tp + fn, conf.level = 0.95, correct = FALSE)
  spec_ci <- prop.test(tn, tn + fp, conf.level = 0.95, correct = FALSE)
  ppv_ci  <- prop.test(tp, tp + fp, conf.level = 0.95, correct = FALSE)
  npv_ci  <- prop.test(tn, tn + fn, conf.level = 0.95, correct = FALSE)

ci_df <- data.frame(
  case_def = case_col,
  sensitivity = tp / (tp + fn),
  sensitivity_lower = sens_ci$conf.int[1],
  sensitivity_upper = sens_ci$conf.int[2],
  specificity = tn / (tn + fp),
  specificity_lower = spec_ci$conf.int[1],
  specificity_upper = spec_ci$conf.int[2],
  ppv = tp / (tp + fp),
  ppv_lower = ppv_ci$conf.int[1],
  ppv_upper = ppv_ci$conf.int[2],
  npv = tn / (tn + fn),
  npv_lower = npv_ci$conf.int[1],
  npv_upper = npv_ci$conf.int[2]
)
  # Store in results list
  results_list[[case_col]] <- ci_df
}

# Combine into one dataframe
results_df <- bind_rows(results_list)

# Look up case def # in case_definitions to see which sypmtom combos it corresponds to

# Determine which case definitions are informative
results_df <- results_df %>% mutate(inform=case_when(
  sensitivity + specificity > 1 ~ 1,
  TRUE ~ 0))

# Among informative case defs, which ones had sens/spec above
informative <- results_df %>% filter(inform==1)
summary(informative$sensitivity)
summary(informative$specificity)

informative_sub <- informative %>% filter(sensitivity>0.50 & specificity>0.5)

# None
# informative_sub <- informative %>% filter(sensitivity>0.60 & specificity>0.6)
# informative_sub <- informative %>% filter(sensitivity>0.70 & specificity>0.7)

# Top 5 informative with highest sens?
metrics_sens_top <- informative_sub %>% arrange(desc(sensitivity))

# Top 5 informative with highest spec?
metrics_spec_top <- informative_sub  %>% arrange(desc(specificity)) 
                               
case_definitions[[8628]]
```

Get the 2x2 table for the top performing case def. Chose 8628 because it has same spec, same number of symptoms, but higher sens 

```{r 2x2}


tabyl(dat_bd_symp$case_def8628)
tabyl(dat_bd_symp, case_def8628, infect_bin)

```


